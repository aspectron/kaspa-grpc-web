import { FlowGRPCWeb } from '@aspectron/flow-grpc-web';
export class RPC {
    constructor(options = {}) {
        this.isReady = false;
        this.queue = [];
        this.verbose = false;
        this.subscribers = new Map();
        this.pending = {};
        this.client = new FlowGRPCWeb(options.grpc || {});
        this.client.on("ready", (clients) => {
            console.log("gRPCWeb::::clients", clients);
            let { RPC } = clients;
            const stream = RPC.MessageStream();
            this.stream = stream;
            console.log("stream", stream);
            stream.on("end", () => {
                console.log("stream end");
            });
            this.initIntake(stream);
            this.isReady = true;
            this.processQueue();
        });
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pendingItem = handlers.shift();
                if (pendingItem)
                    pendingItem.resolve(o.payload);
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    processQueue() {
        if (!this.isReady)
            return;
        let item = this.queue.shift();
        while (item) {
            const resp = item.method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push(item);
            let req = {};
            req[item.method] = item.data;
            this.stream.write(req);
            item = this.queue.shift();
        }
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    subscribe(subject, data = {}, callback) {
        if (typeof data == 'function') {
            callback = data;
            data = {};
        }
        if (!this.client)
            return Promise.reject('not connected');
        let eventName = subject.replace("notify", "").replace("Request", "Notification");
        eventName = eventName[0].toLowerCase() + eventName.substr(1);
        console.log("subscribe:eventName", eventName);
        let subscribers = this.subscribers.get(eventName);
        if (!subscribers) {
            subscribers = [];
            this.subscribers.set(eventName, subscribers);
        }
        let uid = (Math.random() * 100000 + Date.now()).toFixed(0);
        subscribers.push({ uid, callback });
        let p = this.request(subject, data);
        p.uid = uid;
        return p;
    }
    request(method, data) {
        return new Promise((resolve, reject) => {
            this.queue.push({ method, data, resolve, reject });
            this.processQueue();
        });
    }
    getBlock(hash) {
        return this.request('getBlockRequest', { hash, includeBlockVerboseData: true });
    }
    getTransactionsByAddresses(startingBlockHash, addresses) {
        return this.request('getTransactionsByAddressesRequest', { startingBlockHash, addresses });
    }
    getUTXOsByAddress(addresses) {
        return this.request('getUTXOsByAddressRequest', { addresses });
    }
    submitTransaction(tx) {
        return this.request('submitTransactionRequest', tx);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3JwYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFPckQsTUFBTSxPQUFPLEdBQUc7SUFVZixZQUFZLFVBQVksRUFBRTtRQVQxQixZQUFPLEdBQVcsS0FBSyxDQUFDO1FBR3hCLFVBQUssR0FBZSxFQUFFLENBQUM7UUFHdkIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUN4QixnQkFBVyxHQUFzQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksSUFBRSxFQUFFLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFXLEVBQUMsRUFBRTtZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBQzFDLElBQUksRUFBQyxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7WUFFcEIsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ25DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQzdCLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUUsRUFBRTtnQkFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUMxQixDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDcEIsSUFBSSxD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QUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFzQixDQUFDO1FBRXpELENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ1osT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDO0lBQ0QsT0FBTyxDQUFJLE1BQWEsRUFBRSxJQUFRO1FBQ2pDLE9BQU8sSUFBSSxPQUFPLENBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQTtJQUNILENBQUM7SUFDRCxRQUFRLENBQUMsSUFBVztRQUNuQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQW9CLGlCQUFpQixFQUFFLEVBQUMsSUFBSSxFQUFFLHVCQUF1QixFQUFDLElBQUksRUFBQyxDQUFDLENBQUM7SUFDakcsQ0FBQztJQUNELDBCQUEwQixDQUFDLGlCQUF3QixFQUFFLFNBQWtCO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBc0MsbUNBQW1DLEVBQUUsRUFBQyxpQkFBaUIsRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDO0lBQy9ILENBQUM7SUFDRCxpQkFBaUIsQ0FBQyxTQUFrQjtRQUNuQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQStCLDBCQUEwQixFQUFFLEVBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQztJQUM1RixDQUFDO0lBQ0QsaUJBQWlCLENBQUMsRUFBZ0M7UUFDakQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFnQywwQkFBMEIsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNwRixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Zsb3dHUlBDV2VifSBmcm9tICdAYXNwZWN0cm9uL2Zsb3ctZ3JwYy13ZWInO1xuLy9jb25zdCBGbG93R1JQQ1dlYiA9IG5ldyBGbG93R1JQQ1dlYigpO1xuaW1wb3J0IHtJUlBDLCBSUEMgYXMgUnBjLFxuXHRTdWJzY3JpYmVySXRlbSwgU3Vic2NyaWJlckl0ZW1NYXAsXG5cdFF1ZXVlSXRlbSwgUGVuZGluZ1JlcXMsIElEYXRhLCBJU3RyZWFtXG59IGZyb20gJy4uL3R5cGVzL2N1c3RvbS10eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBSUEMgaW1wbGVtZW50cyBJUlBDe1xuXHRpc1JlYWR5OmJvb2xlYW4gPSBmYWxzZTtcblx0Y2xpZW50OkZsb3dHUlBDV2ViO1xuXHRzdHJlYW06SVN0cmVhbTtcblx0cXVldWU6UXVldWVJdGVtW10gPSBbXTtcblx0cGVuZGluZzpQZW5kaW5nUmVxcztcblx0aW50YWtlSGFuZGxlcjpGdW5jdGlvbnx1bmRlZmluZWQ7XG5cdHZlcmJvc2U6Ym9vbGVhbiA9IGZhbHNlO1xuXHRzdWJzY3JpYmVyczogU3Vic2NyaWJlckl0ZW1NYXAgPSBuZXcgTWFwKCk7XG5cblx0Y29uc3RydWN0b3Iob3B0aW9uczphbnk9e30pe1xuXHRcdHRoaXMucGVuZGluZyA9IHt9O1xuXHRcdHRoaXMuY2xpZW50ID0gbmV3IEZsb3dHUlBDV2ViKG9wdGlvbnMuZ3JwY3x8e30pO1xuXG5cdFx0dGhpcy5jbGllbnQub24oXCJyZWFkeVwiLCAoY2xpZW50czphbnkpPT57XG5cdFx0XHRjb25zb2xlLmxvZyhcImdSUENXZWI6Ojo6Y2xpZW50c1wiLCBjbGllbnRzKVxuXHRcdFx0bGV0IHtSUEN9ID0gY2xpZW50cztcblxuXHRcdFx0Y29uc3Qgc3RyZWFtID0gUlBDLk1lc3NhZ2VTdHJlYW0oKTtcblx0XHRcdHRoaXMuc3RyZWFtID0gc3RyZWFtO1xuXHRcdFx0Y29uc29sZS5sb2coXCJzdHJlYW1cIiwgc3RyZWFtKVxuXHRcdFx0c3RyZWFtLm9uKFwiZW5kXCIsICgpPT57XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwic3RyZWFtIGVuZFwiKVxuXHRcdFx0fSk7XG5cdFx0XHR0aGlzLmluaXRJbnRha2Uoc3RyZWFtKTtcblx0XHRcdHRoaXMuaXNSZWFkeSA9IHRydWU7XG5cdFx0XHR0aGlzLnByb2Nlc3NRdWV1ZSgpO1xuXHRcdH0pXG5cdH1cblx0aW5pdEludGFrZShzdHJlYW06SVN0cmVhbSkge1xuICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLChkYXRhOmFueSkgPT4ge1xuICAgICAgICAgICAgaWYoZGF0YS5wYXlsb2FkKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBkYXRhLnBheWxvYWQ7XG4gICAgICAgICAgICAgICAgbGV0IHBheWxvYWQgPSBkYXRhW25hbWVdO1xuICAgICAgICAgICAgICAgIGxldCBpZGVudCA9IG5hbWUucmVwbGFjZSgvXmdldHxSZXNwb25zZSQvaWcsJycpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVJbnRha2Uoe25hbWUsIHBheWxvYWQsIGlkZW50fSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBoYW5kbGVJbnRha2UobzpJRGF0YSkge1xuICAgICAgICBpZih0aGlzLmludGFrZUhhbmRsZXIpIHtcbiAgICAgICAgICAgIHRoaXMuaW50YWtlSGFuZGxlcihvKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBoYW5kbGVycyA9IHRoaXMucGVuZGluZ1tvLm5hbWVdO1xuICAgICAgICAgICAgdGhpcy52ZXJib3NlICYmIGNvbnNvbGUubG9nKCdpbnRha2U6JyxvLCdoYW5kbGVyczonLGhhbmRsZXJzKTtcbiAgICAgICAgICAgIGlmKGhhbmRsZXJzICYmIGhhbmRsZXJzLmxlbmd0aCl7XG4gICAgICAgICAgICBcdGxldCBwZW5kaW5nSXRlbTpRdWV1ZUl0ZW18dW5kZWZpbmVkID0gaGFuZGxlcnMuc2hpZnQoKTtcbiAgICAgICAgICAgIFx0aWYocGVuZGluZ0l0ZW0pXG4gICAgICAgICAgICAgICAgXHRwZW5kaW5nSXRlbS5yZXNvbHZlKG8ucGF5bG9hZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRJbnRha2VIYW5kbGVyKGZuOkZ1bmN0aW9uKSB7XG4gICAgICAgIHRoaXMuaW50YWtlSGFuZGxlciA9IGZuO1xuICAgIH1cblx0cHJvY2Vzc1F1ZXVlKCl7XG5cdFx0aWYoIXRoaXMuaXNSZWFkeSlcblx0XHRcdHJldHVyblxuXG5cdFx0bGV0IGl0ZW06UXVldWVJdGVtfHVuZGVmaW5lZCA9IHRoaXMucXVldWUuc2hpZnQoKTtcblx0XHR3aGlsZShpdGVtKXtcblx0XHRcdGNvbnN0IHJlc3AgPSBpdGVtLm1ldGhvZC5yZXBsYWNlKC9SZXF1ZXN0JC8sJ1Jlc3BvbnNlJyk7XG4gICAgICAgICAgICBpZighdGhpcy5wZW5kaW5nW3Jlc3BdKVxuICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1tyZXNwXSA9IFtdO1xuICAgICAgICAgICAgbGV0IGhhbmRsZXJzOlF1ZXVlSXRlbVtdID0gdGhpcy5wZW5kaW5nW3Jlc3BdO1xuICAgICAgICAgICAgaGFuZGxlcnMucHVzaChpdGVtKTtcblxuXHRcdFx0bGV0IHJlcTphbnkgPSB7fTtcblx0XHRcdHJlcVtpdGVtLm1ldGhvZF0gPSBpdGVtLmRhdGE7XG5cdFx0XHR0aGlzLnN0cmVhbS53cml0ZShyZXEpO1xuXG5cdFx0XHRpdGVtID0gdGhpcy5xdWV1ZS5zaGlmdCgpO1xuXHRcdH1cblx0fVxuXHRjbGVhclBlbmRpbmcoKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMucGVuZGluZykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgbGV0IGxpc3QgPSB0aGlzLnBlbmRpbmdba2V5XTtcbiAgICAgICAgICAgIGxpc3QuZm9yRWFjaChvPT5vLnJlamVjdCgnY2xvc2luZyBieSBmb3JjZScpKTtcbiAgICAgICAgICAgIHRoaXMucGVuZGluZ1trZXldID0gW107XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzdWJzY3JpYmU8VD4oc3ViamVjdDpzdHJpbmcsIGRhdGE6YW55PXt9LCBjYWxsYmFjazpGdW5jdGlvbik6UnBjLlN1YlByb21pc2U8VD57XG5cdFx0aWYodHlwZW9mIGRhdGEgPT0gJ2Z1bmN0aW9uJyl7XG5cdFx0XHRjYWxsYmFjayA9IGRhdGE7XG5cdFx0XHRkYXRhID0ge307XG5cdFx0fVxuXG5cdFx0aWYoIXRoaXMuY2xpZW50KVxuXHRcdFx0cmV0dXJuIFByb21pc2UucmVqZWN0KCdub3QgY29ubmVjdGVkJykgYXMgUnBjLlN1YlByb21pc2U8VD47XG5cblx0XHRsZXQgZXZlbnROYW1lID0gc3ViamVjdC5yZXBsYWNlKFwibm90aWZ5XCIsIFwiXCIpLnJlcGxhY2UoXCJSZXF1ZXN0XCIsIFwiTm90aWZpY2F0aW9uXCIpXG5cdFx0ZXZlbnROYW1lID0gZXZlbnROYW1lWzBdLnRvTG93ZXJDYXNlKCkrZXZlbnROYW1lLnN1YnN0cigxKTtcblx0XHRjb25zb2xlLmxvZyhcInN1YnNjcmliZTpldmVudE5hbWVcIiwgZXZlbnROYW1lKVxuXG5cdFx0bGV0IHN1YnNjcmliZXJzOlN1YnNjcmliZXJJdGVtW118dW5kZWZpbmVkID0gdGhpcy5zdWJzY3JpYmVycy5nZXQoZXZlbnROYW1lKTtcblx0XHRpZighc3Vic2NyaWJlcnMpe1xuXHRcdFx0c3Vic2NyaWJlcnMgPSBbXTtcblx0XHRcdHRoaXMuc3Vic2NyaWJlcnMuc2V0KGV2ZW50TmFtZSwgc3Vic2NyaWJlcnMpO1xuXHRcdH1cblx0XHRsZXQgdWlkID0gKE1hdGgucmFuZG9tKCkqMTAwMDAwICsgRGF0ZS5ub3coKSkudG9GaXhlZCgwKTtcblx0XHRzdWJzY3JpYmVycy5wdXNoKHt1aWQsIGNhbGxiYWNrfSk7XG5cblx0XHRsZXQgcCA9IHRoaXMucmVxdWVzdChzdWJqZWN0LCBkYXRhKSBhcyBScGMuU3ViUHJvbWlzZTxUPjtcblxuXHRcdHAudWlkID0gdWlkO1xuXHRcdHJldHVybiBwO1xuXHR9XG5cdHJlcXVlc3Q8VD4obWV0aG9kOnN0cmluZywgZGF0YTphbnkpe1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXHRcdFx0dGhpcy5xdWV1ZS5wdXNoKHttZXRob2QsIGRhdGEsIHJlc29sdmUsIHJlamVjdH0pO1xuXHRcdFx0dGhpcy5wcm9jZXNzUXVldWUoKTtcblx0XHR9KVxuXHR9XG5cdGdldEJsb2NrKGhhc2g6c3RyaW5nKXtcblx0XHRyZXR1cm4gdGhpcy5yZXF1ZXN0PFJwYy5CbG9ja1Jlc3BvbnNlPignZ2V0QmxvY2tSZXF1ZXN0Jywge2hhc2gsIGluY2x1ZGVCbG9ja1ZlcmJvc2VEYXRhOnRydWV9KTtcblx0fVxuXHRnZXRUcmFuc2FjdGlvbnNCeUFkZHJlc3NlcyhzdGFydGluZ0Jsb2NrSGFzaDpzdHJpbmcsIGFkZHJlc3NlczpzdHJpbmdbXSl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuVHJhbnNhY3Rpb25zQnlBZGRyZXNzZXNSZXNwb25zZT4oJ2dldFRyYW5zYWN0aW9uc0J5QWRkcmVzc2VzUmVxdWVzdCcsIHtzdGFydGluZ0Jsb2NrSGFzaCwgYWRkcmVzc2VzfSk7XG5cdH1cblx0Z2V0VVRYT3NCeUFkZHJlc3MoYWRkcmVzc2VzOnN0cmluZ1tdKXtcblx0XHRyZXR1cm4gdGhpcy5yZXF1ZXN0PFJwYy5VVFhPc0J5QWRkcmVzc2VzUmVzcG9uc2U+KCdnZXRVVFhPc0J5QWRkcmVzc1JlcXVlc3QnLCB7YWRkcmVzc2VzfSk7XG5cdH1cblx0c3VibWl0VHJhbnNhY3Rpb24odHg6IFJwYy5TdWJtaXRUcmFuc2FjdGlvblJlcXVlc3Qpe1xuXHRcdHJldHVybiB0aGlzLnJlcXVlc3Q8UnBjLlN1Ym1pdFRyYW5zYWN0aW9uUmVzcG9uc2U+KCdzdWJtaXRUcmFuc2FjdGlvblJlcXVlc3QnLCB0eCk7XG5cdH1cbn0iXX0=