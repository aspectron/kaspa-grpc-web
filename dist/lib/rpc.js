import { FlowGRPCWeb } from '@aspectron/flow-grpc-web';
export class RPC {
    constructor(options = {}) {
        this.isReady = false;
        this.queue = [];
        this.verbose = false;
        this.subscribers = new Map();
        this.pending = {};
        this.client = new FlowGRPCWeb(options.grpc || {});
        this.client.on("ready", (clients) => {
            console.log("gRPCWeb::::clients", clients);
            let { RPC } = clients;
            const stream = RPC.MessageStream();
            this.stream = stream;
            console.log("stream", stream);
            stream.on("end", () => {
                console.log("stream end");
            });
            this.initIntake(stream);
            this.isReady = true;
            this.processQueue();
        });
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pendingItem = handlers.shift();
                if (pendingItem)
                    pendingItem.resolve(o.payload);
            }
            let subscribers = this.subscribers.get(o.name);
            if (subscribers) {
                subscribers.map(subscriber => {
                    subscriber.callback(o.payload);
                });
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    processQueue() {
        if (!this.isReady)
            return;
        let item = this.queue.shift();
        while (item) {
            const resp = item.method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push(item);
            let req = {};
            req[item.method] = item.data;
            this.stream.write(req);
            item = this.queue.shift();
        }
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    subscribe(subject, data = {}, callback) {
        if (typeof data == 'function') {
            callback = data;
            data = {};
        }
        if (!this.client)
            return Promise.reject('not connected');
        let eventName = subject.replace("notify", "").replace("Request", "Notification");
        eventName = eventName[0].toLowerCase() + eventName.substr(1);
        console.log("subscribe:eventName", eventName);
        let subscribers = this.subscribers.get(eventName);
        if (!subscribers) {
            subscribers = [];
            this.subscribers.set(eventName, subscribers);
        }
        let uid = (Math.random() * 100000 + Date.now()).toFixed(0);
        subscribers.push({ uid, callback });
        let p = this.request(subject, data);
        p.uid = uid;
        return p;
    }
    request(method, data) {
        return new Promise((resolve, reject) => {
            this.queue.push({ method, data, resolve, reject });
            this.processQueue();
        });
    }
    subscribeChainChanged(callback) {
        return this.subscribe("notifyChainChangedRequest", {}, callback);
    }
    subscribeBlockAdded(callback) {
        return this.subscribe("notifyBlockAddedRequest", {}, callback);
    }
    subscribeVirtualSelectedParentBlueScoreChanged(callback) {
        return this.subscribe("notifyVirtualSelectedParentBlueScoreChangedRequest", {}, callback);
    }
    getBlock(hash) {
        return this.request('getBlockRequest', { hash, includeBlockVerboseData: true });
    }
    getTransactionsByAddresses(startingBlockHash, addresses) {
        return this.request('getTransactionsByAddressesRequest', { startingBlockHash, addresses });
    }
    getUtxosByAddresses(addresses) {
        return this.request('getUtxosByAddressesRequest', { addresses });
    }
    submitTransaction(tx) {
        return this.request('submitTransactionRequest', tx);
    }
    getVirtualSelectedParentBlueScore() {
        return this.request('getVirtualSelectedParentBlueScoreRequest', {});
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3JwYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFPckQsTUFBTSxPQUFPLEdBQUc7SUFVZixZQUFZLFVBQVksRUFBRTtRQVQxQixZQUFPLEdBQVcsS0FBSyxDQUFDO1FBR3hCLFVBQUssR0FBZSxFQUFFLENBQUM7UUFHdkIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUN4QixnQkFBVyxHQUFzQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksSUFBRSxFQUFFLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFXLEVBQUMsRUFBRTtZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBQzFDLElBQUksRUFBQyxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7WUFFcEIsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ25DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQzdCLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUUsRUFBRTtnQkFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUMxQixDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDcEIsSUFBSSxD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UUFDbkIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFvQixpQkFBaUIsRUFBRSxFQUFDLElBQUksRUFBRSx1QkFBdUIsRUFBQyxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQ2pHLENBQUM7SUFDRCwwQkFBMEIsQ0FBQyxpQkFBd0IsRUFBRSxTQUFrQjtRQUN0RSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQXNDLG1DQUFtQyxFQUFFLEVBQUMsaUJBQWlCLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQztJQUMvSCxDQUFDO0lBQ0QsbUJBQW1CLENBQUMsU0FBa0I7UUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUErQiw0QkFBNEIsRUFBRSxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUM7SUFDOUYsQ0FBQztJQUNELGlCQUFpQixDQUFDLEVBQWdDO1FBQ2pELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBZ0MsMEJBQTBCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUNELGlDQUFpQztRQUNoQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQTZDLDBDQUEwQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2pILENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Rmxvd0dSUENXZWJ9IGZyb20gJ0Bhc3BlY3Ryb24vZmxvdy1ncnBjLXdlYic7XG4vL2NvbnN0IEZsb3dHUlBDV2ViID0gbmV3IEZsb3dHUlBDV2ViKCk7XG5pbXBvcnQge0lSUEMsIFJQQyBhcyBScGMsXG5cdFN1YnNjcmliZXJJdGVtLCBTdWJzY3JpYmVySXRlbU1hcCxcblx0UXVldWVJdGVtLCBQZW5kaW5nUmVxcywgSURhdGEsIElTdHJlYW1cbn0gZnJvbSAnLi4vdHlwZXMvY3VzdG9tLXR5cGVzJztcblxuZXhwb3J0IGNsYXNzIFJQQyBpbXBsZW1lbnRzIElSUEN7XG5cdGlzUmVhZHk6Ym9vbGVhbiA9IGZhbHNlO1xuXHRjbGllbnQ6Rmxvd0dSUENXZWI7XG5cdHN0cmVhbTpJU3RyZWFtO1xuXHRxdWV1ZTpRdWV1ZUl0ZW1bXSA9IFtdO1xuXHRwZW5kaW5nOlBlbmRpbmdSZXFzO1xuXHRpbnRha2VIYW5kbGVyOkZ1bmN0aW9ufHVuZGVmaW5lZDtcblx0dmVyYm9zZTpib29sZWFuID0gZmFsc2U7XG5cdHN1YnNjcmliZXJzOiBTdWJzY3JpYmVySXRlbU1hcCA9IG5ldyBNYXAoKTtcblxuXHRjb25zdHJ1Y3RvcihvcHRpb25zOmFueT17fSl7XG5cdFx0dGhpcy5wZW5kaW5nID0ge307XG5cdFx0dGhpcy5jbGllbnQgPSBuZXcgRmxvd0dSUENXZWIob3B0aW9ucy5ncnBjfHx7fSk7XG5cblx0XHR0aGlzLmNsaWVudC5vbihcInJlYWR5XCIsIChjbGllbnRzOmFueSk9Pntcblx0XHRcdGNvbnNvbGUubG9nKFwiZ1JQQ1dlYjo6OjpjbGllbnRzXCIsIGNsaWVudHMpXG5cdFx0XHRsZXQge1JQQ30gPSBjbGllbnRzO1xuXG5cdFx0XHRjb25zdCBzdHJlYW0gPSBSUEMuTWVzc2FnZVN0cmVhbSgpO1xuXHRcdFx0dGhpcy5zdHJlYW0gPSBzdHJlYW07XG5cdFx0XHRjb25zb2xlLmxvZyhcInN0cmVhbVwiLCBzdHJlYW0pXG5cdFx0XHRzdHJlYW0ub24oXCJlbmRcIiwgKCk9Pntcblx0XHRcdFx0Y29uc29sZS5sb2coXCJzdHJlYW0gZW5kXCIpXG5cdFx0XHR9KTtcblx0XHRcdHRoaXMuaW5pdEludGFrZShzdHJlYW0pO1xuXHRcdFx0dGhpcy5pc1JlYWR5ID0gdHJ1ZTtcblx0XHRcdHRoaXMucHJvY2Vzc1F1ZXVlKCk7XG5cdFx0fSlcblx0fVxuXHRpbml0SW50YWtlKHN0cmVhbTpJU3RyZWFtKSB7XG4gICAgICAgIHN0cmVhbS5vbignZGF0YScsKGRhdGE6YW55KSA9PiB7XG4gICAgICAgICAgICBpZihkYXRhLnBheWxvYWQpIHtcbiAgICAgICAgICAgICAgICBsZXQgbmFtZSA9IGRhdGEucGF5bG9hZDtcbiAgICAgICAgICAgICAgICBsZXQgcGF5bG9hZCA9IGRhdGFbbmFtZV07XG4gICAgICAgICAgICAgICAgbGV0IGlkZW50ID0gbmFtZS5yZXBsYWNlKC9eZ2V0fFJlc3BvbnNlJC9pZywnJykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUludGFrZSh7bmFtZSwgcGF5bG9hZCwgaWRlbnR9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGhhbmRsZUludGFrZShvOklEYXRhKSB7XG4gICAgICAgIGlmKHRoaXMuaW50YWtlSGFuZGxlcikge1xuICAgICAgICAgICAgdGhpcy5pbnRha2VIYW5kbGVyKG8pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGhhbmRsZXJzID0gdGhpcy5wZW5kaW5nW28ubmFtZV07XG4gICAgICAgICAgICB0aGlzLnZlcmJvc2UgJiYgY29uc29sZS5sb2coJ2ludGFrZTonLG8sJ2hhbmRsZXJzOicsaGFuZGxlcnMpO1xuICAgICAgICAgICAgaWYoaGFuZGxlcnMgJiYgaGFuZGxlcnMubGVuZ3RoKXtcbiAgICAgICAgICAgIFx0bGV0IHBlbmRpbmdJdGVtOlF1ZXVlSXRlbXx1bmRlZmluZWQgPSBoYW5kbGVycy5zaGlmdCgpO1xuICAgICAgICAgICAgXHRpZihwZW5kaW5nSXRlbSlcbiAgICAgICAgICAgICAgICBcdHBlbmRpbmdJdGVtLnJlc29sdmUoby5wYXlsb2FkKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHN1YnNjcmliZXJzOlN1YnNjcmliZXJJdGVtW118dW5kZWZpbmVkID0gdGhpcy5zdWJzY3JpYmVycy5nZXQoby5uYW1lKTtcblx0XHRcdGlmKHN1YnNjcmliZXJzKXtcblx0XHRcdFx0c3Vic2NyaWJlcnMubWFwKHN1YnNjcmliZXI9Pntcblx0XHRcdFx0XHRzdWJzY3JpYmVyLmNhbGxiYWNrKG8ucGF5bG9hZClcblx0XHRcdFx0fSlcblx0XHRcdH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldEludGFrZUhhbmRsZXIoZm46RnVuY3Rpb24pIHtcbiAgICAgICAgdGhpcy5pbnRha2VIYW5kbGVyID0gZm47XG4gICAgfVxuXHRwcm9jZXNzUXVldWUoKXtcblx0XHRpZighdGhpcy5pc1JlYWR5KVxuXHRcdFx0cmV0dXJuXG5cblx0XHRsZXQgaXRlbTpRdWV1ZUl0ZW18dW5kZWZpbmVkID0gdGhpcy5xdWV1ZS5zaGlmdCgpO1xuXHRcdHdoaWxlKGl0ZW0pe1xuXHRcdFx0Y29uc3QgcmVzcCA9IGl0ZW0ubWV0aG9kLnJlcGxhY2UoL1JlcXVlc3QkLywnUmVzcG9uc2UnKTtcbiAgICAgICAgICAgIGlmKCF0aGlzLnBlbmRpbmdbcmVzcF0pXG4gICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nW3Jlc3BdID0gW107XG4gICAgICAgICAgICBsZXQgaGFuZGxlcnM6UXVldWVJdGVtW10gPSB0aGlzLnBlbmRpbmdbcmVzcF07XG4gICAgICAgICAgICBoYW5kbGVycy5wdXNoKGl0ZW0pO1xuXG5cdFx0XHRsZXQgcmVxOmFueSA9IHt9O1xuXHRcdFx0cmVxW2l0ZW0ubWV0aG9kXSA9IGl0ZW0uZGF0YTtcblx0XHRcdHRoaXMuc3RyZWFtLndyaXRlKHJlcSk7XG5cblx0XHRcdGl0ZW0gPSB0aGlzLnF1ZXVlLnNoaWZ0KCk7XG5cdFx0fVxuXHR9XG5cdGNsZWFyUGVuZGluZygpIHtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5wZW5kaW5nKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBsZXQgbGlzdCA9IHRoaXMucGVuZGluZ1trZXldO1xuICAgICAgICAgICAgbGlzdC5mb3JFYWNoKG89Pm8ucmVqZWN0KCdjbG9zaW5nIGJ5IGZvcmNlJykpO1xuICAgICAgICAgICAgdGhpcy5wZW5kaW5nW2tleV0gPSBbXTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHN1YnNjcmliZTxULCBSPihzdWJqZWN0OnN0cmluZywgZGF0YTphbnk9e30sIGNhbGxiYWNrOlJwYy5jYWxsYmFjazxSPik6UnBjLlN1YlByb21pc2U8VD57XG5cdFx0aWYodHlwZW9mIGRhdGEgPT0gJ2Z1bmN0aW9uJyl7XG5cdFx0XHRjYWxsYmFjayA9IGRhdGE7XG5cdFx0XHRkYXRhID0ge307XG5cdFx0fVxuXG5cdFx0aWYoIXRoaXMuY2xpZW50KVxuXHRcdFx0cmV0dXJuIFByb21pc2UucmVqZWN0KCdub3QgY29ubmVjdGVkJykgYXMgUnBjLlN1YlByb21pc2U8VD47XG5cblx0XHRsZXQgZXZlbnROYW1lID0gc3ViamVjdC5yZXBsYWNlKFwibm90aWZ5XCIsIFwiXCIpLnJlcGxhY2UoXCJSZXF1ZXN0XCIsIFwiTm90aWZpY2F0aW9uXCIpXG5cdFx0ZXZlbnROYW1lID0gZXZlbnROYW1lWzBdLnRvTG93ZXJDYXNlKCkrZXZlbnROYW1lLnN1YnN0cigxKTtcblx0XHRjb25zb2xlLmxvZyhcInN1YnNjcmliZTpldmVudE5hbWVcIiwgZXZlbnROYW1lKVxuXG5cdFx0bGV0IHN1YnNjcmliZXJzOlN1YnNjcmliZXJJdGVtW118dW5kZWZpbmVkID0gdGhpcy5zdWJzY3JpYmVycy5nZXQoZXZlbnROYW1lKTtcblx0XHRpZighc3Vic2NyaWJlcnMpe1xuXHRcdFx0c3Vic2NyaWJlcnMgPSBbXTtcblx0XHRcdHRoaXMuc3Vic2NyaWJlcnMuc2V0KGV2ZW50TmFtZSwgc3Vic2NyaWJlcnMpO1xuXHRcdH1cblx0XHRsZXQgdWlkID0gKE1hdGgucmFuZG9tKCkqMTAwMDAwICsgRGF0ZS5ub3coKSkudG9GaXhlZCgwKTtcblx0XHRzdWJzY3JpYmVycy5wdXNoKHt1aWQsIGNhbGxiYWNrfSk7XG5cblx0XHRsZXQgcCA9IHRoaXMucmVxdWVzdChzdWJqZWN0LCBkYXRhKSBhcyBScGMuU3ViUHJvbWlzZTxUPjtcblxuXHRcdHAudWlkID0gdWlkO1xuXHRcdHJldHVybiBwO1xuXHR9XG5cdHJlcXVlc3Q8VD4obWV0aG9kOnN0cmluZywgZGF0YTphbnkpe1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXHRcdFx0dGhpcy5xdWV1ZS5wdXNoKHttZXRob2QsIGRhdGEsIHJlc29sdmUsIHJlamVjdH0pO1xuXHRcdFx0dGhpcy5wcm9jZXNzUXVldWUoKTtcblx0XHR9KVxuXHR9XG5cblx0c3Vic2NyaWJlQ2hhaW5DaGFuZ2VkKGNhbGxiYWNrOlJwYy5jYWxsYmFjazxScGMuQ2hhaW5DaGFuZ2VkTm90aWZpY2F0aW9uPil7XG5cdFx0cmV0dXJuIHRoaXMuc3Vic2NyaWJlPFJwYy5Ob3RpZnlDaGFpbkNoYW5nZWRSZXNwb25zZSwgUnBjLkNoYWluQ2hhbmdlZE5vdGlmaWNhdGlvbj4oXCJub3RpZnlDaGFpbkNoYW5nZWRSZXF1ZXN0XCIsIHt9LCBjYWxsYmFjayk7XG5cdH1cblx0c3Vic2NyaWJlQmxvY2tBZGRlZChjYWxsYmFjazpScGMuY2FsbGJhY2s8UnBjLkJsb2NrQWRkZWROb3RpZmljYXRpb24+KXtcblx0XHRyZXR1cm4gdGhpcy5zdWJzY3JpYmU8UnBjLk5vdGlmeUJsb2NrQWRkZWRSZXNwb25zZSwgUnBjLkJsb2NrQWRkZWROb3RpZmljYXRpb24+KFwibm90aWZ5QmxvY2tBZGRlZFJlcXVlc3RcIiwge30sIGNhbGxiYWNrKTtcblx0fVxuXHRzdWJzY3JpYmVWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVDaGFuZ2VkKGNhbGxiYWNrOlJwYy5jYWxsYmFjazxScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZE5vdGlmaWNhdGlvbj4pe1xuXHRcdHJldHVybiB0aGlzLnN1YnNjcmliZTxScGMuTm90aWZ5VmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZFJlc3BvbnNlLCBScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZE5vdGlmaWNhdGlvbj4oXCJub3RpZnlWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVDaGFuZ2VkUmVxdWVzdFwiLCB7fSwgY2FsbGJhY2spO1xuXHR9XG5cblx0Z2V0QmxvY2soaGFzaDpzdHJpbmcpe1xuXHRcdHJldHVybiB0aGlzLnJlcXVlc3Q8UnBjLkJsb2NrUmVzcG9uc2U+KCdnZXRCbG9ja1JlcXVlc3QnLCB7aGFzaCwgaW5jbHVkZUJsb2NrVmVyYm9zZURhdGE6dHJ1ZX0pO1xuXHR9XG5cdGdldFRyYW5zYWN0aW9uc0J5QWRkcmVzc2VzKHN0YXJ0aW5nQmxvY2tIYXNoOnN0cmluZywgYWRkcmVzc2VzOnN0cmluZ1tdKXtcblx0XHRyZXR1cm4gdGhpcy5yZXF1ZXN0PFJwYy5UcmFuc2FjdGlvbnNCeUFkZHJlc3Nlc1Jlc3BvbnNlPignZ2V0VHJhbnNhY3Rpb25zQnlBZGRyZXNzZXNSZXF1ZXN0Jywge3N0YXJ0aW5nQmxvY2tIYXNoLCBhZGRyZXNzZXN9KTtcblx0fVxuXHRnZXRVdHhvc0J5QWRkcmVzc2VzKGFkZHJlc3NlczpzdHJpbmdbXSl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuVVRYT3NCeUFkZHJlc3Nlc1Jlc3BvbnNlPignZ2V0VXR4b3NCeUFkZHJlc3Nlc1JlcXVlc3QnLCB7YWRkcmVzc2VzfSk7XG5cdH1cblx0c3VibWl0VHJhbnNhY3Rpb24odHg6IFJwYy5TdWJtaXRUcmFuc2FjdGlvblJlcXVlc3Qpe1xuXHRcdHJldHVybiB0aGlzLnJlcXVlc3Q8UnBjLlN1Ym1pdFRyYW5zYWN0aW9uUmVzcG9uc2U+KCdzdWJtaXRUcmFuc2FjdGlvblJlcXVlc3QnLCB0eCk7XG5cdH1cblx0Z2V0VmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlKCl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlUmVzcG9uc2U+KCdnZXRWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVSZXF1ZXN0Jywge30pO1xuXHR9XG59Il19